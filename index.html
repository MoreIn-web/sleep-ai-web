<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sleep AI — Offline Chatbot</title>
  <meta name="description" content="Sleep AI: a lightweight, no-API offline chatbot in one HTML file." />
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0e0f12;
      --panel: #14161b;
      --muted: #8b93a7;
      --text: #e6e9ef;
      --accent: #7c5cff;
      --accent-2: #43d9ad;
      --error: #ff5c7c;
      --border: #232630;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: radial-gradient(1200px 600px at 80% -10%, #182032 0%, rgba(24,32,50,0) 60%) no-repeat, var(--bg);
      color: var(--text);
      font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    .app {
      height: 100%;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px; justify-content: space-between;
      background: linear-gradient(180deg, rgba(124,92,255,0.08), rgba(124,92,255,0));
    }
    .brand {
      display: flex; align-items: center; gap: 10px;
    }
    .logo {
      width: 28px; height: 28px; border-radius: 8px;
      background: conic-gradient(from 200deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 20px rgba(124,92,255,0.35);
    }
    .title { font-weight: 700; letter-spacing: 0.2px; }
    .subtitle { color: var(--muted); font-size: 12px; }
    .actions { display: flex; gap: 8px; }
    button, .btn {
      border: 1px solid var(--border);
      background: #111319;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    button:hover { border-color: #2f3442; }
    .danger { border-color: rgba(255,92,124,0.35); color: #ffd9e0; }
    main {
      overflow: hidden; position: relative;
    }
    .chat {
      height: 100%;
      overflow-y: auto;
      padding: 18px;
      display: flex; flex-direction: column; gap: 12px;
      scroll-behavior: smooth;
    }
    .msg {
      display: grid; grid-template-columns: 40px 1fr; gap: 10px;
      align-items: start;
      animation: fadeIn 180ms ease-out both;
    }
    .avatar {
      width: 36px; height: 36px; border-radius: 50%;
      background: linear-gradient(135deg, rgba(124,92,255,0.25), rgba(67,217,173,0.25));
      display: grid; place-items: center; color: #cfd6ff; font-weight: 700; font-size: 13px;
      border: 1px solid var(--border);
    }
    .bubble {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .you .bubble { background: #10131a; }
    .meta {
      margin-top: 6px; font-size: 12px; color: var(--muted);
    }
    .inputbar {
      border-top: 1px solid var(--border);
      padding: 10px 14px;
      display: grid; grid-template-columns: 1fr auto; gap: 10px;
      background: linear-gradient(180deg, rgba(67,217,173,0.06), rgba(67,217,173,0));
    }
    textarea {
      width: 100%;
      resize: none; min-height: 44px; max-height: 220px;
      border-radius: 12px; border: 1px solid var(--border);
      background: #0f1218; color: var(--text);
      padding: 10px 12px;
      outline: none;
    }
    .send {
      display: inline-flex; align-items: center; gap: 8px;
      background: linear-gradient(135deg, rgba(124,92,255,0.25), rgba(67,217,173,0.25));
      border: 1px solid #2a2f3f;
      padding: 8px 12px; border-radius: 12px;
    }
    .hint {
      text-align: center; color: var(--muted); font-size: 12px; padding: 6px 0 10px 0;
    }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(2px)} to {opacity: 1; transform: translateY(0)} }
    .kbd {
      border: 1px solid var(--border); border-bottom-width: 2px; padding: 0 6px; border-radius: 6px; font-size: 11px; color: var(--muted);
      background: #10131a;
    }
    .pill {
      display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; color: #cde9ff;
      border: 1px solid #2b3344; background: #0e141f;
    }
    .row { display: flex; gap: 6px; flex-wrap: wrap; }
    .system { color: var(--muted); font-size: 13px; text-align: center; padding: 8px 0; }
    .small { font-size: 12px; color: var(--muted); }
    .link { color: #b9c4ff; text-decoration: underline dotted; text-underline-offset: 2px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Sleep AI</div>
          <div class="subtitle">Offline chatbot — no APIs, just JavaScript</div>
        </div>
      </div>
      <div class="actions">
        <button id="copyBtn" title="Copy chat to clipboard">Copy</button>
        <button id="clearBtn" class="danger" title="Clear chat">Clear</button>
      </div>
    </header>

    <main>
      <div id="chat" class="chat" aria-live="polite" aria-label="Chat transcript"></div>
      <div class="hint">
        Try: <span class="pill">What is AI?</span>
        <span class="pill">2.5 km to miles</span>
        <span class="pill">now in Sylhet</span>
        <span class="pill">Tell me a joke</span>
        <span class="pill">3*(4+5)^2</span>
      </div>
    </main>

    <div class="inputbar">
      <textarea id="input" placeholder="Ask anything... Shift+Enter = new line" rows="1"></textarea>
      <button id="send" class="send">Send ⮞</button>
    </div>
  </div>

  <script>
    // Sleep AI: entirely local, no network calls. Lightweight intent handling + retrieval + utilities.

    // Utilities
    const $ = (sel, el = document) => el.querySelector(sel);
    const chatEl = $('#chat');
    const inputEl = $('#input');
    const sendBtn = $('#send');
    const clearBtn = $('#clearBtn');
    const copyBtn = $('#copyBtn');

    const nowStr = () => new Date().toLocaleString();
    const timeStr = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    function addMessage(role, text) {
      const row = document.createElement('div');
      row.className = 'msg ' + (role === 'user' ? 'you' : 'bot');
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = role === 'user' ? 'YOU' : 'AI';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      // Render as plain text to avoid XSS
      bubble.textContent = text;
      const meta = document.createElement('div');
      meta.className = 'meta small';
      meta.textContent = role === 'user' ? 'You • ' + timeStr() : 'Sleep AI • ' + timeStr();

      row.appendChild(avatar);
      const wrap = document.createElement('div');
      wrap.appendChild(bubble);
      wrap.appendChild(meta);
      row.appendChild(wrap);

      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
      persist();
    }

    function systemNote(text) {
      const div = document.createElement('div');
      div.className = 'system';
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // Local storage
    const STORE_KEY = 'sleep-ai-chat-v1';
    function persist() {
      const entries = [...chatEl.querySelectorAll('.msg')].map(node => {
        const role = node.classList.contains('you') ? 'user' : 'bot';
        const text = node.querySelector('.bubble')?.textContent || '';
        return { role, text };
      });
      localStorage.setItem(STORE_KEY, JSON.stringify(entries));
    }
    function restore() {
      const data = localStorage.getItem(STORE_KEY);
      if (!data) {
        welcome();
        return;
      }
      try {
        const entries = JSON.parse(data);
        for (const m of entries) addMessage(m.role, m.text);
      } catch {
        welcome();
      }
    }

    function welcome() {
      addMessage('bot',
`Hey — I’m Sleep AI. I run entirely in your browser, no APIs.
I can:
• answer common questions from a small offline brain,
• do math,
• convert units,
• tell time/date,
• craft thoughtful tips when I don’t know.
Ask me anything.`);
    }

    // Basic NLP helpers
    const STOP = new Set(['the','a','an','and','or','but','if','then','is','are','to','of','in','on','for','with','as','by','at','from','that','this','it','be','was','were','am','i','you','we','they','he','she','them','us','my','your','our','their']);
    const tokenize = s => s
      .toLowerCase()
      .replace(/[^a-z0-9\s\.\-\+\/\*\^\%\(\)]/g, ' ')
      .split(/\s+/)
      .filter(Boolean);

    function bag(tokens) {
      const b = new Map();
      for (const t of tokens) {
        if (STOP.has(t)) continue;
        b.set(t, (b.get(t) || 0) + 1);
      }
      return b;
    }
    function cosineSim(a, b) {
      let dot = 0, na = 0, nb = 0;
      const keys = new Set([...a.keys(), ...b.keys()]);
      for (const k of keys) {
        const va = a.get(k) || 0;
        const vb = b.get(k) || 0;
        dot += va * vb;
        na += va * va;
        nb += vb * vb;
      }
      if (!na || !nb) return 0;
      return dot / (Math.sqrt(na) * Math.sqrt(nb));
    }

    // Small offline knowledge base
    const KB = [
      {
        q: 'what is ai',
        a: 'Artificial intelligence (AI) is the field of building systems that perform tasks that typically require human intelligence—like understanding language, recognizing patterns, solving problems, and making decisions.',
        tags: ['ai','artificial','intelligence','ml','machine','learning']
      },
      {
        q: 'what is machine learning',
        a: 'Machine learning is a subset of AI focused on algorithms that learn patterns from data to make predictions or decisions without being explicitly programmed for each case.',
        tags: ['ml','machine','learning','ai']
      },
      {
        q: 'what is github pages',
        a: 'GitHub Pages hosts static websites directly from a GitHub repository. Put an index.html in your repo, enable Pages in Settings, and your site goes live on a github.io URL.',
        tags: ['github','pages','hosting','static','website']
      },
      {
        q: 'how to deploy a single html file on github pages',
        a: 'Create a public repo, add index.html at the root, commit and push, then enable GitHub Pages from Settings → Pages with the default branch. Wait a minute for it to publish.',
        tags: ['deploy','single','file','html','github','pages']
      },
      {
        q: 'what is html',
        a: 'HTML (HyperText Markup Language) structures content on the web using elements like headings, paragraphs, links, images, and forms.',
        tags: ['html','web','markup']
      },
      {
        q: 'what is css',
        a: 'CSS (Cascading Style Sheets) controls the look and layout of web pages—colors, spacing, fonts, grid and flex layouts, and animations.',
        tags: ['css','style','design']
      },
      {
        q: 'what is javascript',
        a: 'JavaScript is the programming language of the web used to add logic, interactivity, data handling, and dynamic UI updates in the browser.',
        tags: ['javascript','programming','web']
      },
      {
        q: 'tell me about bangladesh',
        a: 'Bangladesh is a South Asian country on the Bay of Bengal, known for its rivers, tea gardens, vibrant culture, and rapidly growing economy. The capital is Dhaka.',
        tags: ['bangladesh','south','asia','dhaka','country']
      },
      {
        q: 'tell me about sylhet',
        a: 'Sylhet, in northeastern Bangladesh, is famous for tea estates, lush hills, shrines, and natural beauty around Jaflong and Ratargul Swamp Forest.',
        tags: ['sylhet','bangladesh','city','tea']
      },
      {
        q: 'what is sleep ai',
        a: 'Sleep AI is this lightweight, offline demo chatbot. It runs fully in your browser—no network calls, no external APIs.',
        tags: ['sleep','ai','offline','chatbot']
      },
      {
        q: 'how to learn programming fast',
        a: 'Pick one language, build tiny real projects, get feedback daily, and mix reading with deliberate practice. Ship small, iterate, and keep a learning journal.',
        tags: ['learn','programming','advice','study']
      },
      {
        q: 'give productivity tips',
        a: 'Use a daily top-3, time-block deep work, protect sleep, reduce context switching, and end the day with a 5-minute plan for tomorrow.',
        tags: ['productivity','tips','focus']
      }
    ];
    const KB_BAGS = KB.map(item => ({ item, bag: bag(tokenize(item.q + ' ' + item.tags.join(' '))) }));

    function retrieve(query) {
      const qbag = bag(tokenize(query));
      let best = null, bestScore = 0;
      for (const row of KB_BAGS) {
        const score = cosineSim(qbag, row.bag);
        if (score > bestScore) { bestScore = score; best = row.item; }
      }
      return (bestScore >= 0.18) ? best : null; // modest threshold
    }

    // Intent detection
    function isGreeting(s) {
      return /\b(hi|hello|hey|assalamu|salaam|salam)\b/i.test(s);
    }
    function wantsTime(s) {
      return /\b(time|date|day|now)\b/i.test(s);
    }
    function wantsJoke(s) {
      return /\b(joke|funny|laugh)\b/i.test(s);
    }
    function looksMath(s) {
      // contains only math-safe chars and at least one operator
      const cleaned = s.replace(/\s+/g,'');
      return /^[0-9\.\+\-\*\/\^\%\(\)]+$/.test(cleaned) && /[\+\-\*\/\^\%]/.test(cleaned);
    }
    function wantsConvert(s) {
      return /\bconvert\b|\bto\b/i.test(s) && /[0-9]/.test(s);
    }
    function wantsDefine(s) {
      return /\bdefine\b|\bmeaning of\b/i.test(s);
    }
    function wantsHelp(s) {
      return /^\s*\/?(help|commands)\s*$/i.test(s);
    }
    function wantsClear(s) {
      return /^\s*\/?(clear|reset)\s*$/i.test(s);
    }
    function wantsAbout(s) {
      return /^\s*\/?about\s*$/i.test(s);
    }

    // Jokes
    const JOKES = [
      'Why do programmers prefer dark mode? Because light attracts bugs.',
      'I told my computer I needed a break, and it said “No problem, I’ll go to sleep.”',
      'There are 10 kinds of people: those who understand binary and those who don’t.'
    ];

    // Math evaluator (sanitized)
    function evalMath(expr) {
      const safe = expr.replace(/[^0-9\.\+\-\*\/\^\%\(\)\s]/g, '');
      if (!/[\d\)]$/.test(safe)) return 'I could not parse that expression.';
      const js = safe.replace(/\^/g, '**'); // exponent
      try {
        const val = Function('"use strict"; return (' + js + ')')();
        if (typeof val === 'number' && isFinite(val)) return String(val);
        return 'That did not evaluate to a finite number.';
      } catch {
        return 'I could not evaluate that. Try a simpler expression.';
      }
    }

    // Unit conversions
    const UNITS = {
      // length in meters
      m: 1, meter:1, meters:1,
      km: 1000, kilometer:1000, kilometers:1000,
      cm: 0.01, centimeter:0.01, centimeters:0.01,
      mm: 0.001, millimeter:0.001, millimeters:0.001,
      mi: 1609.344, mile:1609.344, miles:1609.344,
      yd: 0.9144, yard:0.9144, yards:0.9144,
      ft: 0.3048, foot:0.3048, feet:0.3048,
      in: 0.0254, inch:0.0254, inches:0.0254,

      // mass in kilograms
      kg_unit: NaN, // marker
      kg: 'kg', kilogram:'kg', kilograms:'kg',
      g: 'g', gram:'g', grams:'g',
      lb: 'lb', lbs:'lb', pound:'lb', pounds:'lb',
      oz: 'oz', ounce:'oz', ounces:'oz'
    };
    const MASS = {
      kg: 1,
      g: 1/1000,
      lb: 0.45359237,
      oz: 0.028349523125
    };

    function parseConvert(q) {
      // patterns like "convert 10 km to miles" or "2.5 km to mi" or "10 c to f"
      const m = q.toLowerCase().match(/(-?\d+(\.\d+)?)\s*([a-z]+)\s*(to|in)\s*([a-z]+)/);
      if (!m) return null;
      const value = parseFloat(m[1]);
      const from = m[3];
      const to = m[5];

      // temperature?
      const temps = new Set(['c','celsius','°c','f','fahrenheit','°f','k','kelvin']);
      if (temps.has(from) && temps.has(to)) {
        return { kind: 'temp', value, from, to };
      }

      // mass?
      if (from in MASS || normalizeMass(from) in MASS || to in MASS || normalizeMass(to) in MASS) {
        return { kind: 'mass', value, from, to };
      }

      // length fallback
      return { kind: 'length', value, from, to };
    }

    function normalizeMass(u) {
      if (['kg','kilogram','kilograms'].includes(u)) return 'kg';
      if (['g','gram','grams'].includes(u)) return 'g';
      if (['lb','lbs','pound','pounds'].includes(u)) return 'lb';
      if (['oz','ounce','ounces'].includes(u)) return 'oz';
      return u;
    }

    function convertLength(v, from, to) {
      const f = UNITS[from];
      const t = UNITS[to];
      if (typeof f !== 'number' || typeof t !== 'number') return null;
      const meters = v * f;
      return meters / t;
    }

    function convertMass(v, from, to) {
      const f = MASS[normalizeMass(from)];
      const t = MASS[normalizeMass(to)];
      if (!f || !t) return null;
      const kg = v * f;
      return kg / t;
    }

    function convertTemp(v, from, to) {
      const F = ['f','fahrenheit','°f'];
      const C = ['c','celsius','°c'];
      const K = ['k','kelvin'];
      const inSet = (u, set) => set.includes(u);

      let celsius;
      if (inSet(from, C)) celsius = v;
      else if (inSet(from, K)) celsius = v - 273.15;
      else if (inSet(from, F)) celsius = (v - 32) * 5/9;
      else return null;

      if (inSet(to, C)) return celsius;
      if (inSet(to, K)) return celsius + 273.15;
      if (inSet(to, F)) return (celsius * 9/5) + 32;
      return null;
    }

    function formatNum(n) {
      const abs = Math.abs(n);
      const digits = abs >= 1 ? 4 : 6;
      return Number(n.toFixed(digits)).toString();
    }

    // Definition stub
    const DICT = {
      algorithm: 'A step-by-step procedure for solving a problem or performing a computation.',
      compiler: 'A program that translates source code into a lower-level language (often machine code).',
      recursion: 'A technique where a function calls itself to solve smaller instances of a problem.',
      entropy: 'A measure of uncertainty or disorder; in information theory, average information per message.'
    };

    // Core response logic
    function respond(text) {
      const q = text.trim();
      if (!q) return "Say something and I’ll answer.";
      if (wantsClear(q)) {
        clearChat();
        return "Cleared. Fresh start.";
      }
      if (wantsHelp(q)) {
        return [
          'Commands:',
          '/help — show this list',
          '/about — what this is',
          '/clear — reset the chat',
          '',
          'Built-in skills:',
          '• General Q&A (small offline knowledge)',
          '• Math: e.g., 3*(4+5)^2',
          '• Convert: “2.5 km to miles”, “32 F to C”, “10 lb to kg”',
          '• Time/Date: “what time is it”, “date today”',
          '• Jokes: “tell me a joke”'
        ].join('\n');
      }
      if (wantsAbout(q)) {
        return 'Sleep AI: a single-file, no-API chatbot. Everything runs in your browser using JavaScript.';
      }
      if (isGreeting(q)) {
        return 'Hello! Ask me anything—math, conversions, quick facts, or advice.';
      }
      if (wantsTime(q)) {
        const d = new Date();
        return `Right now: ${d.toLocaleString()}`;
      }
      if (wantsJoke(q)) {
        return JOKES[Math.floor(Math.random() * JOKES.length)];
      }
      if (looksMath(q)) {
        const res = evalMath(q);
        return res.startsWith('I could') || res.startsWith('That did')
          ? res
          : `${q} = ${res}`;
      }
      if (wantsConvert(q)) {
        const parsed = parseConvert(q);
        if (parsed) {
          const { kind, value, from, to } = parsed;
          let out = null;
          if (kind === 'temp') out = convertTemp(value, from, to);
          else if (kind === 'mass') out = convertMass(value, from, to);
          else out = convertLength(value, from, to);
          if (out == null || Number.isNaN(out)) return 'I could not do that conversion. Try like: 2.5 km to miles';
          return `${value} ${from} ≈ ${formatNum(out)} ${to}`;
        }
      }
      if (wantsDefine(q)) {
        const m = q.toLowerCase().match(/define\s+([a-z\-]+)/) || q.toLowerCase().match(/meaning of\s+([a-z\-]+)/);
        const word = m ? m[1] : '';
        if (word && DICT[word]) return `${word}: ${DICT[word]}`;
        return word ? `I don’t have a built-in definition for “${word}”.` : 'Which word should I define?';
      }

      // Retrieval
      const hit = retrieve(q);
      if (hit) return hit.a;

      // Reflective, structured fallback
      return thoughtfulAnswer(q);
    }

    function thoughtfulAnswer(q) {
      // Simple heuristic templates to feel helpful without external data.
      if (/^how\b/i.test(q)) {
        return [
          'Here’s a simple approach:',
          '1) Clarify the goal and constraints.',
          '2) Break it into the smallest possible steps.',
          '3) Do the first step that reduces uncertainty.',
          '4) Review feedback, then iterate.',
          'If you want, tell me your context and I’ll tailor a step-by-step plan.'
        ].join('\n');
      }
      if (/^why\b/i.test(q)) {
        return [
          'Often there are multiple causes:',
          '• Immediate factors (what just happened)',
          '• Underlying patterns (habits, systems, incentives)',
          '• Constraints (time, resources, skills)',
          'Check each layer. Which one seems most likely here?'
        ].join('\n');
      }
      if (/^(what|who|where)\b/i.test(q)) {
        return [
          'I work offline, so I can’t fetch live facts.',
          'If you add a bit more detail, I’ll synthesize a clear summary or example.'
        ].join('\n');
      }
      // General-purpose coaching nudge
      return [
        'I don’t have that offline, but here’s a way forward:',
        '• Define the outcome you want in one sentence.',
        '• List 3 constraints you must respect.',
        '• Pick the smallest next action you can finish in 10 minutes.',
        'Tell me these, and I’ll map a plan.'
      ].join('\n');
    }

    // Chat flow
    function handleSend() {
      const text = inputEl.value;
      if (!text.trim()) return;
      addMessage('user', text);
      inputEl.value = '';
      // Simulate thinking
      setTimeout(() => {
        const reply = respond(text);
        addMessage('bot', reply);
      }, 120);
    }

    function clearChat() {
      chatEl.innerHTML = '';
      localStorage.removeItem(STORE_KEY);
      systemNote('Chat cleared.');
    }

    // Events
    sendBtn.addEventListener('click', handleSend);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });
    clearBtn.addEventListener('click', () => {
      clearChat();
    });
    copyBtn.addEventListener('click', async () => {
      const entries = [...chatEl.querySelectorAll('.msg')].map(node => {
        const role = node.classList.contains('you') ? 'You' : 'Sleep AI';
        const text = node.querySelector('.bubble')?.textContent || '';
        return `${role}: ${text}`;
      }).join('\n\n');
      try {
        await navigator.clipboard.writeText(entries || '(empty)');
        systemNote('Copied chat to clipboard.');
      } catch {
        systemNote('Copy failed. Select and copy manually.');
      }
    });

    // Seed and restore
    restore();

    // Example quick-pills interaction
    document.querySelectorAll('.pill').forEach(p => {
      p.addEventListener('click', () => {
        inputEl.value = p.textContent;
        inputEl.focus();
      });
    });
  </script>
</body>
</html>
